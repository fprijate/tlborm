<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Internal Rules - The Little Book of Rust Macros</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded "><a href="mbe-README.html"><strong aria-hidden="true">1.</strong> Macros, A Methodical Introduction</a></li><li><ol class="section"><li class="expanded "><a href="mbe-syn-README.html"><strong aria-hidden="true">1.1.</strong> Syntax Extensions</a></li><li><ol class="section"><li class="expanded "><a href="mbe-syn-source-analysis.html"><strong aria-hidden="true">1.1.1.</strong> Source Analysis</a></li><li class="expanded "><a href="mbe-syn-macros-in-the-ast.html"><strong aria-hidden="true">1.1.2.</strong> Macros in the AST</a></li><li class="expanded "><a href="mbe-syn-expansion.html"><strong aria-hidden="true">1.1.3.</strong> Expansion</a></li></ol></li><li class="expanded "><a href="mbe-macro-rules.html"><strong aria-hidden="true">1.2.</strong> macro_rules!</a></li><li class="expanded "><a href="mbe-min-README.html"><strong aria-hidden="true">1.3.</strong> Minutiae</a></li><li><ol class="section"><li class="expanded "><a href="mbe-min-captures-and-expansion-redux.html"><strong aria-hidden="true">1.3.1.</strong> Captures and Expansion Redux</a></li><li class="expanded "><a href="mbe-min-hygiene.html"><strong aria-hidden="true">1.3.2.</strong> Hygiene</a></li><li class="expanded "><a href="mbe-min-non-identifier-identifiers.html"><strong aria-hidden="true">1.3.3.</strong> Non-Identifier Identifiers</a></li><li class="expanded "><a href="mbe-min-debugging.html"><strong aria-hidden="true">1.3.4.</strong> Debugging</a></li><li class="expanded "><a href="mbe-min-scoping.html"><strong aria-hidden="true">1.3.5.</strong> Scoping</a></li><li class="expanded "><a href="mbe-min-import-export.html"><strong aria-hidden="true">1.3.6.</strong> Import/Export</a></li></ol></li></ol></li><li class="expanded "><a href="pim-README.html"><strong aria-hidden="true">2.</strong> Macros, A Practical Introduction</a></li><li class="expanded "><a href="pat-README.html"><strong aria-hidden="true">3.</strong> Patterns</a></li><li><ol class="section"><li class="expanded "><a href="pat-callbacks.html"><strong aria-hidden="true">3.1.</strong> Callbacks</a></li><li class="expanded "><a href="pat-incremental-tt-munchers.html"><strong aria-hidden="true">3.2.</strong> Incremental TT Munchers</a></li><li class="expanded "><a href="pat-internal-rules.html" class="active"><strong aria-hidden="true">3.3.</strong> Internal Rules</a></li><li class="expanded "><a href="pat-push-down-accumulation.html"><strong aria-hidden="true">3.4.</strong> Push-Down Accumulation</a></li><li class="expanded "><a href="pat-repetition-replacement.html"><strong aria-hidden="true">3.5.</strong> Repetition Replacement</a></li><li class="expanded "><a href="pat-trailing-separators.html"><strong aria-hidden="true">3.6.</strong> Trailing Separators</a></li><li class="expanded "><a href="pat-tt-bundling.html"><strong aria-hidden="true">3.7.</strong> TT Bundling</a></li><li class="expanded "><a href="pat-visibility.html"><strong aria-hidden="true">3.8.</strong> Visibility</a></li><li class="expanded "><a href="pat-provisional.html"><strong aria-hidden="true">3.9.</strong> Provisional</a></li></ol></li><li class="expanded "><a href="blk-README.html"><strong aria-hidden="true">4.</strong> Building Blocks</a></li><li><ol class="section"><li class="expanded "><a href="blk-ast-coercion.html"><strong aria-hidden="true">4.1.</strong> AST Coercion</a></li><li class="expanded "><a href="blk-counting.html"><strong aria-hidden="true">4.2.</strong> Counting</a></li><li class="expanded "><a href="blk-enum-parsing.html"><strong aria-hidden="true">4.3.</strong> Enum Parsing</a></li></ol></li><li class="expanded "><a href="aeg-README.html"><strong aria-hidden="true">5.</strong> Annotated Examples</a></li><li><ol class="section"><li class="expanded "><a href="aeg-ook.html"><strong aria-hidden="true">5.1.</strong> Ook!</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">The Little Book of Rust Macros</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#internal-rules" id="internal-rules">Internal rules</a></h1>
<pre><pre class="playpen"><code class="language-rust">#[macro_export]
macro_rules! foo {
    (@as_expr $e:expr) =&gt; {$e};

    ($($tts:tt)*) =&gt; {
        foo!(@as_expr $($tts)*)
    };
}
<span class="boring">
</span><span class="boring">fn main() {
</span><span class="boring">    assert_eq!(foo!(42), 42);
</span><span class="boring">}
</span></code></pre></pre>
<p>Because macros do not interact with regular item privacy or lookup, any public macro <em>must</em> bring with it all other macros that it depends on.  This can lead to pollution of the global macro namespace, or even conflicts with macros from other crates.  It may also cause confusion to users who attempt to <em>selectively</em> import macros: they must transitively import <em>all</em> macros, including ones that may not be publicly documented.</p>
<p>A good solution is to conceal what would otherwise be other public macros <em>inside</em> the macro being exported.  The above example shows how the common <code>as_expr!</code> macro could be moved <em>into</em> the publicly exported macro that is using it.</p>
<p>The reason for using <code>@</code> is that, as of Rust 1.2, the <code>@</code> token is <em>not</em> used in prefix position; as such, it cannot conflict with anything.  Other symbols or unique prefixes may be used as desired, but use of <code>@</code> has started to become widespread, so using it may aid readers in understanding your code.</p>
<blockquote>
<p><strong>Note</strong>: the <code>@</code> token was previously used in prefix position to denote a garbage-collected pointer, back when the language used sigils to denote pointer types.  Its only <em>current</em> purpose is for binding names to patterns.  For this, however, it is used as an <em>infix</em> operator, and thus does not conflict with its use here.</p>
</blockquote>
<p>Additionally, internal rules will often come <em>before</em> any &quot;bare&quot; rules, to avoid issues with <code>macro_rules!</code> incorrectly attempting to parse an internal invocation as something it cannot possibly be, such as an expression.</p>
<p>If exporting at least one internal macro is unavoidable (<em>e.g.</em> you have many macros that depend on a common set of utility rules), you can use this pattern to combine <em>all</em> internal macros into a single uber-macro.</p>
<pre><code class="language-ignore">macro_rules! crate_name_util {
    (@as_expr $e:expr) =&gt; {$e};
    (@as_item $i:item) =&gt; {$i};
    (@count_tts) =&gt; {0usize};
    // ...
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="pat-incremental-tt-munchers.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="pat-push-down-accumulation.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="pat-incremental-tt-munchers.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="pat-push-down-accumulation.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3001");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload(true); // force reload from server (not from cache)
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
